# This file is a template, and might need editing before it works on your project.
# Official framework image. Look for the different tagged releases at:
# https://hub.docker.com/r/library/node/tags/
#image: node:latest

stages:
  - build
  - package
  - deploy

#before_scripts:
#  
#
variables:
  S3_BUCKET_NAME: "accenture-fashionpair.lab.impekable.com"
  S3_DEFAULT_REGION: "us-west-1"
#
#
# This folder is cached between builds
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache
cache:
  paths:
  - node_modules/

build:
  stage: build
  image: node:latest
  script:
  - npm install
  - npm run build
  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    paths:
    - client/
    - server/
    expire_in: 2 mins

package-client:
  stage: package
  script:
  - ls -laR client
  - ls -laR server
  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    paths:
    - client/
    - server/
    expire_in: 2 mins

# deploy-client-production:
#   stage: deploy
#   environment: production
#   image: python:latest
#   script:
#   - pip install awscli
#   - aws s3 cp ./client/dist s3://$S3_BUCKET_NAME/ --recursive
#   only:
#   - master
#   artifacts:
#     name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
#     paths:
#     - client/
#     expire_in: 1 week

deploy-client-dev:
  stage: deploy
  image: python:latest
  variables:
    S3_BUCKET_NAME: "dev.accenture-fashionpair.lab.impekable.com"
  script:
  - pip install awscli
  - mkdir -p ./pack/$CI_BUILD_REF_NAME
  - cp -R ./client/dist/* ./pack/$CI_BUILD_REF_NAME/
  - aws s3 cp ./pack/ s3://$S3_BUCKET_NAME/ --recursive
  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    paths:
    - client/
    expire_in: 1 week

